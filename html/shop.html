<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Shop - Imposter</title>
    <link rel="stylesheet" href="../css/style.css" />
  </head>
  <body>
    <div class="app-shell fullscreen-page">
      <aside class="sidebar" aria-label="Main navigation">
        <div class="sidebar-top">
          <button id="sidebarToggle" class="hamburger" aria-label="Toggle menu">‚ò∞</button>
          <div class="logo"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" fill="#00b4ff"/><path d="M7 12h10M12 7v10" stroke="#001" stroke-width="1.2" stroke-linecap="round"/></svg><span>Imposter</span><small>Word Game</small></div>
        </div>
        <nav>
          <a href="index.html"><span class="icon">üè†</span><span class="label">Home</span></a>
          <a href="play.html"><span class="icon">‚ñ∂Ô∏è</span><span class="label">Play</span></a>
          <a href="account.html"><span class="icon">üë§</span><span class="label">Account</span></a>
          <a href="leaderboards.html"><span class="icon">üèÜ</span><span class="label">Leaderboards</span></a>
          <a href="shop.html"><span class="icon">üõí</span><span class="label">Shop</span></a>
          <a id="sidebarAdminLink" href="admin.html" style="display:none;"><span class="icon">‚öôÔ∏è</span><span class="label">Admin</span></a>
        </nav>
        <div id="playerAccountInfo" class="account-preview"></div>
      </aside>

      <main class="content">
        <div id="topRightInfo" class="top-right-info" aria-hidden="true"></div>
        
        <!-- Battle Pass Modal -->
        <div id="battlePassModal" class="bp-modal" style="display:none;">
          <div class="bp-modal-content">
            <div class="bp-modal-close-btn" id="closeBpBtn">‚úï</div>
            <div class="bp-header">
              <div class="bp-title">üéñÔ∏è BATTLE PASS</div>
              <div class="bp-tier-display">TIER <span id="bpTier" class="bp-tier-num">1</span></div>
            </div>
            <div class="bp-progress-container">
              <div id="bpProgress" class="bp-progress-bar">
                <div id="bpProgressBar" class="bp-progress-fill"></div>
              </div>
              <div id="bpXP" class="bp-xp-text">0 / 30 XP</div>
            </div>
            <div class="bp-strip" id="bpStrip"></div>
          </div>
        </div>
        
        <!-- Battle Pass Toggle Button (Bottom Right) -->
        <button id="bpToggleBtn" class="bp-toggle-btn">üéñÔ∏è PASS</button>
        
      <section class="shop">
        <h1>üõí Cosmetics Shop</h1>
        <div class="shop-header">
          <p>Customize your profile with exclusive cosmetics!</p>
          <div id="gemsDisplay" style="display:none; font-size:1.2em; font-weight:bold;">üíé <span id="gemsCount">0</span> Gems</div>
          <div id="shopLoginPrompt" style="text-align:center; padding:20px; color:#9fdcff; display:none;">
            <p style="font-size:1.1em;">üîê Log in to the shop</p>
          </div>
        </div>
        <div id="shopGrid" class="shop-grid"></div>
      </section>
    </main>
  </div>
  <script src="../js/crypto-utils.js"></script>
  <script src="../js/account.js"></script>
  <script src="../js/game.js"></script>
  <script>
    // Auto-clear old caches on every load
    if ('caches' in window) {
      caches.keys().then(names => {
        names.forEach(name => {
          if (name.startsWith('imposter-game-')) {
            caches.delete(name);
          }
        });
      });
    }

    // Rarity color mapping
    const rarityColors = {
      common: '#999',
      uncommon: '#4fc3f7',
      rare: '#1976d2',
      epic: '#7c4dff',
      legendary: '#ffc400'
    };

    async function loadShop() {
      const grid = document.getElementById('shopGrid');
      const loginPrompt = document.getElementById('shopLoginPrompt');
      const gemsDisplay = document.getElementById('gemsDisplay');
      const user = getCurrentUser();
      
      grid.innerHTML = '';

      if (!user && !GameAPI.isAuthenticated) {
        loginPrompt.style.display = 'block';
        gemsDisplay.style.display = 'none';
        return;
      }

      loginPrompt.style.display = 'none';
      
      try {
        // Fetch cosmetics from server
        const itemsRes = await fetch('/api/shop/items');
        const items = await itemsRes.json();

        let playerInventory = [];
        let playerGems = 0;

        if (GameAPI.isAuthenticated) {
          try {
            const invRes = await fetch('/api/shop/inventory', {
              headers: { 'Authorization': `Bearer ${GameAPI.token}` }
            });
            playerInventory = await invRes.json() || [];

            const playerRes = await fetch(`/api/player/${GameAPI.playerId}`, {
              headers: { 'Authorization': `Bearer ${GameAPI.token}` }
            });
            const playerData = await playerRes.json();
            playerGems = playerData.gems || 0;
          } catch (e) {
            console.error('Failed to fetch inventory:', e);
          }
        }

        gemsDisplay.style.display = 'block';
        document.getElementById('gemsCount').textContent = playerGems;

        if (items.length === 0) {
          grid.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:#9fdcff;">No cosmetics available yet.</p>';
          return;
        }

        // Group by type
        const byType = {};
        items.forEach(item => {
          if (!byType[item.type]) byType[item.type] = [];
          byType[item.type].push(item);
        });

        // Render by type
        Object.entries(byType).forEach(([type, typeItems]) => {
          const typeLabel = document.createElement('div');
          typeLabel.style.cssText = 'grid-column:1/-1; font-size:0.9em; color:#00b4ff; text-transform:uppercase; margin-top:10px; margin-bottom:5px;';
          typeLabel.textContent = `üìç ${type}`;
          grid.appendChild(typeLabel);

          typeItems.forEach(item => {
            const card = document.createElement('div');
            card.className = 'cosmetic-card';
            card.style.cssText = `
              background: linear-gradient(135deg, #1a1a2e, #16213e);
              border: 2px solid ${rarityColors[item.rarity] || '#999'};
              border-radius: 8px;
              padding: 12px;
              display: flex;
              flex-direction: column;
              gap: 8px;
            `;

            const invItem = playerInventory.find(pi => pi.id === item.id);
            const isOwned = invItem?.owned;
            const isEquipped = invItem?.equipped;

            // Asset preview
            const preview = document.createElement('div');
            preview.style.cssText = 'width:100%; height:100px; background:#0f0f1a; border-radius:4px; display:flex; align-items:center; justify-content:center; overflow:hidden;';
            if (item.assetUrl) {
              const img = document.createElement('img');
              img.src = item.assetUrl;
              img.style.cssText = 'max-width:100%; max-height:100%; object-fit:contain;';
              preview.appendChild(img);
            } else {
              preview.textContent = item.type.substring(0, 3).toUpperCase();
              preview.style.color = '#666';
            }
            card.appendChild(preview);

            // Name & Rarity
            const header = document.createElement('div');
            header.style.cssText = 'display:flex; justify-content:space-between; align-items:center;';
            const name = document.createElement('h4');
            name.style.cssText = 'margin:0; font-size:0.9em;';
            name.textContent = item.name;
            const rarity = document.createElement('span');
            rarity.style.cssText = `font-size:0.75em; color:${rarityColors[item.rarity]}; text-transform:uppercase; font-weight:bold;`;
            rarity.textContent = item.rarity;
            header.appendChild(name);
            header.appendChild(rarity);
            card.appendChild(header);

            // Description
            const desc = document.createElement('p');
            desc.style.cssText = 'margin:0; font-size:0.8em; color:#9fdcff;';
            desc.textContent = item.description || 'Unique cosmetic';
            card.appendChild(desc);

            // Price
            const price = document.createElement('div');
            price.style.cssText = 'font-size:0.9em; font-weight:bold; color:#ffc400;';
            price.textContent = `üíé ${item.price} Gems`;
            card.appendChild(price);

            // Action Buttons
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = 'display:flex; gap:6px;';

            if (isOwned) {
              const equipBtn = document.createElement('button');
              equipBtn.style.cssText = `
                flex:1; padding:6px; border:none; border-radius:4px;
                background:${isEquipped ? '#00b4ff' : '#1a3a52'}; color:#fff;
                cursor:pointer; font-size:0.8em; font-weight:bold;
              `;
              equipBtn.textContent = isEquipped ? '‚úì Equipped' : 'Equip';
              equipBtn.addEventListener('click', () => equipCosmetic(item.id, () => loadShop()));
              buttonContainer.appendChild(equipBtn);
            } else {
              const buyBtn = document.createElement('button');
              buyBtn.style.cssText = `
                flex:1; padding:6px; border:none; border-radius:4px;
                background:${playerGems >= item.price ? '#4caf50' : '#555'}; color:#fff;
                cursor:${playerGems >= item.price ? 'pointer' : 'not-allowed'}; 
                font-size:0.8em; font-weight:bold;
              `;
              buyBtn.textContent = 'Buy';
              buyBtn.disabled = playerGems < item.price;
              buyBtn.addEventListener('click', () => buyCosmetic(item.id, item.price, () => loadShop()));
              buttonContainer.appendChild(buyBtn);

              // Gift button (pay with gems)
              const giftBtn = document.createElement('button');
              giftBtn.style.cssText = `flex:1; padding:6px; border:none; border-radius:4px; background:#0069c0; color:#fff; cursor:pointer; font-size:0.8em; font-weight:bold;`;
              giftBtn.textContent = 'Gift';
              giftBtn.disabled = playerGems < item.price;
              giftBtn.addEventListener('click', () => giftCosmetic(item.id, item.price));
              buttonContainer.appendChild(giftBtn);
            }

            card.appendChild(buttonContainer);
            grid.appendChild(card);
          });
        });
      } catch (e) {
        console.error('Failed to load shop:', e);
        grid.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:#ff6b6b;">Failed to load cosmetics</p>';
      }
    }

    async function buyCosmetic(itemId, price, callback) {
      if (!GameAPI.isAuthenticated) return alert('Please log in to purchase');
      
      try {
        const res = await fetch(`/api/shop/buy/${itemId}`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${GameAPI.token}` }
        });
        const data = await res.json();
        if (!res.ok) return alert(data.error || 'Purchase failed');
        alert('‚úì Purchase successful!');
        callback();
      } catch (e) {
        alert('Purchase error: ' + e.message);
      }
    }

    async function giftCosmetic(itemId, price) {
      if (!GameAPI.isAuthenticated) return alert('Please log in to gift');
      const recipient = prompt('Enter recipient username');
      if (!recipient) return;
      const message = prompt('Optional message to include with gift (leave blank for none)') || '';

      try {
        const res = await fetch(`/api/shop/gift/${itemId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${GameAPI.token}` },
          body: JSON.stringify({ recipientUsername: recipient, method: 'gems', autoAccept: true, message })
        });
        const data = await res.json();
        if (!res.ok) return alert(data.error || 'Gift failed');
        alert(data.delivered ? 'Gift sent and delivered!' : 'Gift queued (pending)');
        loadShop();
      } catch (e) {
        alert('Gift error: ' + e.message);
      }
    }

    async function equipCosmetic(itemId, callback) {
      if (!GameAPI.isAuthenticated) return alert('Please log in');
      
      try {
        const res = await fetch(`/api/shop/equip/${itemId}`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${GameAPI.token}` }
        });
        const data = await res.json();
        if (!res.ok) return alert(data.error || 'Equip failed');
        alert('‚úì Cosmetic equipped!');
        callback();
      } catch (e) {
        alert('Equip error: ' + e.message);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadShop();
      // Sidebar toggle
      const btn = document.getElementById('sidebarToggle');
      const sidebar = document.querySelector('.sidebar');
      if (!sidebar) return;
      try {
        const collapsed = localStorage.getItem('sidebarCollapsed') === '1';
        if (collapsed) sidebar.classList.add('collapsed');
      } catch (e) {}
      if (btn) btn.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        try { localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed') ? '1' : '0'); } catch (e) {}
      });
    });
  </script>
  </body>
</html>
